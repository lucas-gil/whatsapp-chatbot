# ğŸ¬ Fluxo Visual Completo do Chatbot

## 1ï¸âƒ£ Entrada do UsuÃ¡rio

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         UsuÃ¡rio no WhatsApp              â”‚
â”‚                                          â”‚
â”‚  ğŸ“± "Oi, tudo bem?"                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚
                  â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚    Cloud API WhatsApp (Meta)             â”‚
â”‚    Recebe mensagem POST /webhook         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚
                  â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  API NodeJS (Fastify)                   â”‚
â”‚  - Valida assinatura webhook            â”‚
â”‚  - Parse mensagem                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 2ï¸âƒ£ Processamento (FlowService)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  FlowService.processMessage()            â”‚
â”‚                                          â”‚
â”‚  1. Encontrar/criar Contato             â”‚
â”‚  2. Encontrar/criar Conversa            â”‚
â”‚  3. Salvar mensagem recebida            â”‚
â”‚  4. Verificar comando global            â”‚
â”‚  5. Navegar estado atual                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â–¼                   â–¼
    [Comando Global]    [State Machine]
    - menu                welcome
    - suporte              device_selection
    - voltar              installation_instructions
    - cancelar            awaiting_installation_proof
                          main_menu
                          contratar_menu
                          renovacao
                          suporte
```

---

## 3ï¸âƒ£ Resposta com IA (AIService)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  AIService.generateResponse()            â”‚
â”‚                                          â”‚
â”‚  1. Buscar documentos relevantes (RAG)  â”‚
â”‚  2. Manter histÃ³rico por usuÃ¡rio        â”‚
â”‚  3. Chamar OpenAI/Gemini com contexto   â”‚
â”‚  4. Retornar resposta                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â–¼                   â–¼
    Base de Conhecimento  OpenAI/Gemini
    - FAQ                 - gpt-4-turbo
    - InstalaÃ§Ãµes        - Gemini Pro
    - PolÃ­ticas
```

---

## 4ï¸âƒ£ Armazenamento (Prisma)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  PostgreSQL (Banco de Dados)             â”‚
â”‚                                          â”‚
â”‚  Tabelas:                                â”‚
â”‚  â”œâ”€â”€ Contact (UsuÃ¡rios)                 â”‚
â”‚  â”œâ”€â”€ Conversation (Chats)               â”‚
â”‚  â”œâ”€â”€ Message (Mensagens)                â”‚
â”‚  â”œâ”€â”€ Subscription (Assinaturas)         â”‚
â”‚  â”œâ”€â”€ Payment (Pagamentos)               â”‚
â”‚  â”œâ”€â”€ Ticket (Suporte)                   â”‚
â”‚  â”œâ”€â”€ Plan (Planos)                      â”‚
â”‚  â”œâ”€â”€ KnowledgeBase (FAQ)                â”‚
â”‚  â””â”€â”€ ... (9 tabelas no total)           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚
                  â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Redis (Cache/SessÃµes)                   â”‚
â”‚  - HistÃ³rico de IA                      â”‚
â”‚  - Filas de processamento               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 5ï¸âƒ£ Resposta ao UsuÃ¡rio

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  WhatsAppService.send*()                 â”‚
â”‚                                          â”‚
â”‚  OpÃ§Ãµes:                                 â”‚
â”‚  - sendText()          â†’ Texto           â”‚
â”‚  - sendButtonMessage() â†’ BotÃµes (â‰¤3)     â”‚
â”‚  - sendListMessage()   â†’ Lista           â”‚
â”‚  - sendImage()         â†’ Imagem          â”‚
â”‚  - sendVideo()         â†’ VÃ­deo           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚
                  â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Cloud API WhatsApp                      â”‚
â”‚  POST /messages                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚
                  â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ğŸ“± UsuÃ¡rio recebe no WhatsApp           â”‚
â”‚                                          â”‚
â”‚  Bot: "Bem-vindo! ğŸ‘‹                    â”‚
â”‚        Escolha seu dispositivo:          â”‚
â”‚        ğŸ“± SMARTPHONE                     â”‚
â”‚        ğŸ“º TV SMART                       â”‚
â”‚        ğŸ“¦ TV BOX"                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ’³ Fluxo de Pagamento

```
UsuÃ¡rio escolhe: "CONTRATAR PLANO"
         â”‚
         â–¼
Bot lista: BÃ¡sico (R$29,99) | Premium (R$59,99)
         â”‚
         â–¼
UsuÃ¡rio clica: "Premium"
         â”‚
         â–¼
PaymentService.createPreference()
         â”‚
         â”œâ”€â†’ Mercado Pago API
         â”‚
         â–¼
Link de pagamento gerado
         â”‚
         â–¼
Bot envia link: "ğŸ’³ Clique para pagar"
         â”‚
         â–¼
UsuÃ¡rio abre link â†’ Paga (PIX/CartÃ£o)
         â”‚
         â–¼
Webhook Mercado Pago: payment.approved
         â”‚
         â–¼
Subscription.status = "active"
         â”‚
         â–¼
Bot envia: "Bem-vindo! âœ… Seu acesso foi liberado!"
```

---

## ğŸ« Fluxo de Suporte

```
UsuÃ¡rio: "Tenho um problema"
         â”‚
         â–¼
Bot: "Qual Ã© a categoria?"
  - InstalaÃ§Ã£o
  - Erro tÃ©cnico
  - Pagamento
  - Outro
         â”‚
         â–¼
UsuÃ¡rio escolhe: "Erro tÃ©cnico"
         â”‚
         â–¼
Bot: "Descreva o erro"
         â”‚
         â–¼
UsuÃ¡rio: "App estÃ¡ travando"
         â”‚
         â–¼
Bot cria Ticket:
  - category: "erro_tecnico"
  - status: "open"
  - priority: "normal"
         â”‚
         â–¼
Notificar Suporte (via Telegram/Email)
         â”‚
         â–¼
Admin vÃª no Dashboard
         â”‚
         â–¼
Admin responde via Chat
         â”‚
         â–¼
Bot encaminha resposta ao usuÃ¡rio
```

---

## ğŸ“Š Dashboard Admin

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     ADMIN DASHBOARD                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                         â”‚
â”‚  ğŸ“Š KPIs (Real-time)                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚
â”‚  â”‚ 126      â”‚ 34       â”‚ 12       â”‚ 28       â”‚         â”‚
â”‚  â”‚ Contatos â”‚ Chats    â”‚ Tickets  â”‚ Clientes â”‚         â”‚
â”‚  â”‚          â”‚ Ativos   â”‚ Abertos  â”‚          â”‚         â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚
â”‚                                                         â”‚
â”‚  ğŸ“± Contatos Recentes                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
â”‚  â”‚ Telefone     â”‚ Nome      â”‚ Dispositivo â”‚ Status  â”‚   â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤       â”‚
â”‚  â”‚ 11 99998888 â”‚ JoÃ£o      â”‚ SMARTPHONE  â”‚ Lead    â”‚   â”‚
â”‚  â”‚ 11 99997777 â”‚ Maria     â”‚ TV SMART    â”‚ Cliente â”‚   â”‚
â”‚  â”‚ 11 99996666 â”‚ Pedro     â”‚ -           â”‚ Prospectâ”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
â”‚                                                         â”‚
â”‚  [Listar Tickets] [Gerenciar Planos] [HistÃ³ricos]     â”‚
â”‚                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ”„ Estado da Conversa (State Machine)

```
START
  â”‚
  â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ welcome                 â”‚  â†’ Envia boas-vindas + vÃ­deo
â”‚ (Step 1)                â”‚     Oferece: Qual dispositivo?
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”
    â–¼                 â–¼
[Smartphone]      [TV Smart]
    â”‚                 â”‚
    â–¼                 â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ device_selection         â”‚  â†’ Envia instruÃ§Ãµes
â”‚ (Step 2)                 â”‚     Oferece: Instalou?
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”
    â–¼                 â–¼
[Sim]             [NÃ£o]
    â”‚                 â”‚
    â–¼                 â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ awaiting_installation_proof            â”‚
â”‚ (Step 3)                               â”‚  â†’ Aguarda print/foto
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”
    â–¼                 â–¼
[Imagem OK]      [Erro/Ajuda]
    â”‚                 â”‚
    â–¼                 â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ main_menu                            â”‚  â†’ Menu principal
â”‚ (Step 4)                             â”‚     Oferece: Contratar/Renovar/Suporte
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚
   â”Œâ”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”
   â–¼      â–¼      â–¼
 [Contratar] [Renovar] [Suporte]
   â”‚          â”‚         â”‚
   â–¼          â–¼         â–¼
[Payment]  [Check]   [Ticket]
   â”‚          â”‚         â”‚
   â–¼          â–¼         â–¼
[End]      [End]      [End]
```

---

## ğŸ” SeguranÃ§a

```
Mensagem recebida
  â”‚
  â–¼
Validar assinatura webhook
  â”‚ (x-hub-signature-256)
  â–¼
Verificar Verify Token
  â”‚
  â–¼
Limpar nÃºmero de telefone
  â”‚ (apenas dÃ­gitos)
  â–¼
Validar entrada de usuÃ¡rio
  â”‚
  â–¼
Rate limit (Redis)
  â”‚
  â–¼
Procesar com seguranÃ§a
```

---

## ğŸ“ˆ Escalabilidade

```
Localmente (Desenvolvimento)
â”œâ”€â”€ PostgreSQL local
â”œâ”€â”€ Redis local
â””â”€â”€ API + Admin em localhost

Docker (Teste)
â”œâ”€â”€ PostgreSQL container
â”œâ”€â”€ Redis container
â””â”€â”€ API/Admin containers

ProduÃ§Ã£o (Railway/Render)
â”œâ”€â”€ PostgreSQL RDS
â”œâ”€â”€ Redis Cloud
â”œâ”€â”€ API scalÃ¡vel
â””â”€â”€ Admin CDN
```

---

**Leia os documentos para configuraÃ§Ã£o detalhada! ğŸ“š**
